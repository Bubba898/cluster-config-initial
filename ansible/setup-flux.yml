---
- name: Setup Flux GitOps
  hosts: localhost
  become: false
  connection: local
  gather_facts: false

  tasks:
    - name: Ensure Flux CLI is installed on controller
      ansible.builtin.shell: |
        set -euo pipefail
        command -v flux >/dev/null 2>&1 || { echo "Flux CLI not found. Install from https://fluxcd.io/docs/installation/" >&2; exit 1; }
      args:
        executable: /bin/bash

    - name: Verify kubeconfig is valid and cluster is accessible
      ansible.builtin.shell: |
        set -euo pipefail
        if ! kubectl cluster-info >/dev/null 2>&1; then
          echo "ERROR: Cannot connect to Kubernetes cluster." >&2
          echo "If you just reset the cluster, the kubeconfig may be outdated." >&2
          echo "Please run: ansible-playbook setup-kubeconfig.yml" >&2
          exit 1
        fi
      args:
        executable: /bin/bash

    - name: Ensure flux-system namespace exists
      ansible.builtin.shell: |
        set -euo pipefail
        kubectl get ns flux-system >/dev/null 2>&1 || kubectl create ns flux-system
      args:
        executable: /bin/bash

    - name: Apply cluster parameters ConfigMap for Flux substitutions
      ansible.builtin.shell: |
        set -euo pipefail
        kubectl -n flux-system create configmap cluster-params \
          --from-literal=INGRESS_IP='{{ ingress_ip }}' \
          --dry-run=client -o yaml | kubectl apply -f -
      args:
        executable: /bin/bash

    - name: Install or upgrade Flux controllers
      ansible.builtin.shell: |
        set -euo pipefail
        flux install
      args:
        executable: /bin/bash

    - name: Apply Flux Git sync manifests
      ansible.builtin.shell: |
        set -euo pipefail
        sed "s|<BOOTSTRAP_GIT_REPO_URL>|{{ bootstrap_git_repo_url }}|g" "{{ playbook_dir }}/../clusters/home/flux-system/gotk-sync.yaml" | kubectl apply -f -
      args:
        executable: /bin/bash

    - name: Wait for Flux GitRepository to be ready
      ansible.builtin.shell: |
        set -euo pipefail
        kubectl wait --for=condition=Ready --timeout=5m -n flux-system gitrepository/cluster-config
      args:
        executable: /bin/bash
      retries: 3
      delay: 10

    - name: Reconcile GitRepository source
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile source git cluster-config --timeout=5m
      args:
        executable: /bin/bash

    - name: Reconcile infrastructure kustomization
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile kustomization infrastructure --timeout=5m
        kubectl wait --for=condition=Ready --timeout=5m -n flux-system kustomization/infrastructure
      args:
        executable: /bin/bash
      retries: 2
      delay: 10

    - name: Reconcile metallb-config kustomization
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile kustomization metallb-config --timeout=5m
        kubectl wait --for=condition=Ready --timeout=5m -n flux-system kustomization/metallb-config
      args:
        executable: /bin/bash
      retries: 2
      delay: 10

    - name: Reconcile istio kustomization
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile kustomization istio --timeout=5m
        kubectl wait --for=condition=Ready --timeout=5m -n flux-system kustomization/istio
      args:
        executable: /bin/bash
      retries: 2
      delay: 10

    - name: Reconcile istio-config kustomization
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile kustomization istio-config --timeout=5m
        kubectl wait --for=condition=Ready --timeout=5m -n flux-system kustomization/istio-config
      args:
        executable: /bin/bash
      retries: 2
      delay: 10

    - name: Reconcile observability kustomization
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile kustomization observability --timeout=5m
        kubectl wait --for=condition=Ready --timeout=5m -n flux-system kustomization/observability
      args:
        executable: /bin/bash
      retries: 2
      delay: 10

    - name: Reconcile apps kustomization
      ansible.builtin.shell: |
        set -euo pipefail
        flux reconcile kustomization apps --timeout=10m
        kubectl wait --for=condition=Ready --timeout=10m -n flux-system kustomization/apps
      args:
        executable: /bin/bash
      retries: 2
      delay: 10

    - name: Display Flux reconciliation complete message
      ansible.builtin.debug:
        msg: "âœ“ Flux reconciliation complete! All kustomizations are ready."

